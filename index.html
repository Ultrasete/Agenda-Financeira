<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Vida - Agenda Financeira</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Melhorias para Mobile */
        input, select, button { touch-action: manipulation; }
        .tap-target { min-height: 44px; }
        
        /* Animação suave */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Scroll escondido mas funcional */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { this.setState({ error: error }); console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center text-red-800"><h1>Algo correu mal.</h1><button onClick={()=>window.location.reload()} className="mt-4 bg-red-700 text-white px-4 py-2 rounded">Recarregar</button></div>;
                return this.props.children;
            }
        }

        // --- ÍCONES SVG ---
        const icons = {
            'dollar-sign': <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            'trending-up': <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>,
            'trending-down': <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></>,
            'credit-card': <><rect x="1" y="4" width="22" height="16" rx="2" ry="2" /><line x1="1" y1="10" x2="23" y2="10" /></>,
            'briefcase': <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            'users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            'trash-2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'plus': <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            'download': <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            'refresh-cw': <><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></>,
            'menu': <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
            'calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            'list': <><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>,
            'pie-chart': <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></>,
            'lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            'unlock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></>,
            'file-text': <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
            'clock': <circle cx="12" cy="12" r="10"></circle>,
            'check': <polyline points="20 6 9 17 4 12"></polyline>,
            'filter': <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>,
            'edit-2': <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></>
        };

        const IconWrapper = ({ name, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ display: 'inline-block', verticalAlign: 'middle' }}>
                {icons[name] || null}
            </svg>
        );

        // --- HOOK PERSISTÊNCIA ---
        function usePersistentState(key, initialValue) {
            const [state, setState] = useState(() => {
                try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch { return initialValue; }
            });
            useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
            return [state, setState];
        }

        // --- COMPONENTE GRÁFICO DE PIZZA (SVG) ---
        const SimplePieChart = ({ data, onSliceClick }) => {
            const validData = data.filter(d => d.value > 0);
            const total = validData.reduce((acc, item) => acc + item.value, 0);
            
            if (total === 0 && data.some(d => d.value !== 0)) {
                return <div className="text-center text-gray-400 p-4 text-sm">Gráfico indisponível para valores negativos/zerados.</div>;
            }
            if (total === 0) return <div className="text-center text-gray-400 p-4 text-sm">Sem dados para o gráfico</div>;
            
            let cumulativeAngle = 0;

            return (
                <div className="flex flex-col items-center bg-white p-6 rounded-xl shadow-lg border border-gray-100 mt-8 mb-8">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><IconWrapper name="pie-chart" className="text-purple-500"/> Distribuição Financeira</h3>
                    <p className="text-xs text-gray-400 mb-4">Toque nas fatias para ver detalhes</p>
                    <div className="relative w-48 h-48">
                        <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)', width: '100%', height: '100%' }}>
                            {validData.map((slice, index) => {
                                const startAngle = cumulativeAngle;
                                const sliceAngle = (slice.value / total) * 2 * Math.PI;
                                cumulativeAngle += sliceAngle;

                                const x1 = Math.cos(startAngle);
                                const y1 = Math.sin(startAngle);
                                const x2 = Math.cos(startAngle + sliceAngle);
                                const y2 = Math.sin(startAngle + sliceAngle);

                                const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;
                                
                                if (validData.length === 1) {
                                    return <circle 
                                        key={index} 
                                        cx="0" cy="0" r="1" 
                                        fill={slice.color} 
                                        onClick={() => onSliceClick && onSliceClick(slice.label)}
                                        style={{ cursor: 'pointer' }}
                                    />;
                                }

                                const pathData = [
                                    `M 0 0`,
                                    `L ${x1} ${y1}`,
                                    `A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                                    `Z`
                                ].join(' ');

                                return (
                                    <path 
                                        key={index} 
                                        d={pathData} 
                                        fill={slice.color} 
                                        stroke="white" 
                                        strokeWidth="0.05" 
                                        onClick={() => onSliceClick && onSliceClick(slice.label)}
                                        style={{ cursor: 'pointer' }}
                                    />
                                );
                            })}
                        </svg>
                    </div>
                    <div className="mt-6 w-full grid grid-cols-1 gap-3">
                        {data.map((item, i) => (
                            <div 
                                key={i} 
                                className="flex items-center justify-between p-2 rounded bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors"
                                onClick={() => onSliceClick && onSliceClick(item.label)}
                            >
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: item.color}}></div>
                                    <span className="text-gray-600 text-xs font-bold uppercase">{item.label}</span>
                                </div>
                                <span className="font-bold text-gray-800 text-sm">R$ {item.value.toFixed(2)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function FinancialApp() {
            // ESTADOS GLOBAIS
            const [view, setView] = useState('transactions'); 
            
            // ESTADOS DE DADOS
            const [financialEntries, setFinancialEntries] = usePersistentState('financialEntries_v4', []);
            const [userAssets, setUserAssets] = usePersistentState('userAssets_v3', []);
            const [userLoans, setUserLoans] = usePersistentState('userLoans_v3', []);
            const [userCards, setUserCards] = usePersistentState('userCards_v3', []);
            const [userInvestments, setUserInvestments] = usePersistentState('userInvestments_v1', []);
            const [userDebts, setUserDebts] = usePersistentState('userDebts_v3', []); 
            const [expandedCardId, setExpandedCardId] = useState(null);
            const [historyFilter, setHistoryFilter] = useState('all'); 
            
            // ESTADO DE EDIÇÃO
            const [editingId, setEditingId] = useState(null); 

            // ESTADOS DE SENHA
            const [appPassword, setAppPassword] = usePersistentState('appPassword', ''); 
            const [isLocked, setIsLocked] = useState(false); 
            const [pinInput, setPinInput] = useState(''); 
            const [newPasswordInput, setNewPasswordInput] = useState(''); 

            // FORMS
            const [finForm, setFinForm] = useState({ 
                date: new Date().toISOString().split('T')[0], 
                desc: '', value: '', type: 'expense', category: 'Outros', method: 'Dinheiro', installments: 1, cardId: '' 
            });
            const [assetForm, setAssetForm] = useState({ name: '', value: '' });
            const [loanForm, setLoanForm] = useState({ name: '', desc: '', value: '', date: '' });
            const [cardForm, setCardForm] = useState({ name: '', limit: '', dueDay: '' });
            const [investmentForm, setInvestmentForm] = useState({ type: 'Poupança', name: '', value: '' });
            const [debtForm, setDebtForm] = useState({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' });

            // EFEITO PARA FORÇAR O BLOQUEIO
            useEffect(() => {
                const savedPass = localStorage.getItem('appPassword');
                if (savedPass && savedPass !== '""') { 
                     setIsLocked(true);
                }
            }, []);

            // CÁLCULOS FINANCEIROS
            const summary = useMemo(() => {
                const realizedEntries = financialEntries.filter(e => e.status === 'paid');
                const income = realizedEntries.filter(e => e.type === 'income').reduce((acc, curr) => acc + curr.value, 0);
                const expense = realizedEntries.filter(e => e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                const pendingExpense = financialEntries.filter(e => e.status === 'pending' && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                return { income, expense, balance: income - expense, pendingExpense };
            }, [financialEntries]);

            // CÁLCULOS GRÁFICO
            const chartData = useMemo(() => {
                const totalReceivable = userLoans.reduce((acc, curr) => acc + curr.value, 0);
                const totalCardDebt = financialEntries
                    .filter(e => e.method === 'Cartão Crédito' && e.type === 'expense')
                    .reduce((acc, curr) => acc + curr.value, 0);
                const currentBalance = summary.balance;
                return [
                    { label: 'Saldo em Caixa', value: currentBalance, color: '#10B981' }, 
                    { label: 'A Receber', value: totalReceivable, color: '#F59E0B' }, 
                    { label: 'Gasto c/ Cartão', value: totalCardDebt, color: '#EF4444' } 
                ];
            }, [userLoans, financialEntries, summary.balance]);

            // LÓGICA SENHA
            const handleUnlock = () => { if (pinInput === appPassword) { setIsLocked(false); setPinInput(''); } else { alert("Senha incorreta!"); setPinInput(''); } };
            const handleSetPassword = () => { if (newPasswordInput.length < 4) return alert("Mínimo 4 dígitos."); setAppPassword(newPasswordInput); setNewPasswordInput(''); alert("Senha definida!"); };
            const handleRemovePassword = () => { if (confirm("Remover proteção?")) { setAppPassword(''); alert("Senha removida."); } };

            // LÓGICA NAVEGAÇÃO GRÁFICO
            const handlePieClick = (label) => {
                if (label === 'Saldo em Caixa') setView('transactions');
                else if (label === 'A Receber') setView('loans');
                else if (label === 'Gasto c/ Cartão') setView('cards');
            };

            // LÓGICA FINANCEIRA AUXILIAR
            const getTotalCardUsage = (cardId) => {
                return financialEntries.filter(e => e.method === 'Cartão Crédito' && e.cardId === cardId && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
            };

            const getCurrentInvoiceValue = (cardId) => {
                const now = new Date();
                const currentMonth = now.getMonth(); 
                const currentYear = now.getFullYear();
                return financialEntries.filter(e => {
                        if (e.method !== 'Cartão Crédito' || e.cardId !== cardId || e.type !== 'expense') return false;
                        const [y, m, d] = e.date.split('-').map(Number);
                        return (m - 1) === currentMonth && y === currentYear;
                    }).reduce((acc, curr) => acc + curr.value, 0);
            };

            // ADD FLUXO
            const handleAddEntry = () => {
                if (!finForm.desc || !finForm.value) return alert("Preencha descrição e valor.");
                if (finForm.method === 'Cartão Crédito' && !finForm.cardId && userCards.length > 0) return alert("Selecione o cartão.");

                const totalValue = parseFloat(finForm.value);

                // LÓGICA DE EDIÇÃO
                if (editingId) {
                    if (!window.confirm("Confirma a alteração deste lançamento?")) return;
                    
                    setFinancialEntries(financialEntries.map(entry => {
                        if (entry.id === editingId) {
                            return {
                                ...entry,
                                date: finForm.date,
                                desc: finForm.desc,
                                value: totalValue,
                                type: finForm.type,
                                category: finForm.category,
                                method: finForm.method,
                                cardId: finForm.method === 'Cartão Crédito' ? finForm.cardId : null
                                // Mantém o status original
                            };
                        }
                        return entry;
                    }));
                    setEditingId(null); // Sai do modo edição
                    setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); // Limpa form
                    alert("Registo atualizado!");
                    return;
                }

                // LÓGICA DE ADIÇÃO (NOVO)
                const numInstallments = parseInt(finForm.installments) || 1;
                const installmentValue = totalValue / numInstallments;
                const newEntries = [];
                
                let startDate; 
                
                if (finForm.method === 'Cartão Crédito' && finForm.cardId) {
                    const selectedCard = userCards.find(c => c.id === finForm.cardId);
                    if (selectedCard && selectedCard.dueDay) {
                        const dueDay = parseInt(selectedCard.dueDay);
                        const [y, m, d] = finForm.date.split('-').map(Number);
                        // Ajuste para mês 0-indexado
                        const purchaseDate = new Date(y, m - 1, d);
                        
                        let nextMonth = purchaseDate.getMonth() + 1;
                        let year = purchaseDate.getFullYear();
                        if (nextMonth > 11) { nextMonth = 0; year++; }
                        
                        startDate = new Date(year, nextMonth, dueDay);
                    } else {
                         // Fallback
                         const [y, m, d] = finForm.date.split('-').map(Number);
                         startDate = new Date(y, m - 1, d);
                         startDate.setMonth(startDate.getMonth() + 1);
                    }
                } else if (finForm.method === 'Carnê/Boleto') {
                    const [y, m, d] = finForm.date.split('-').map(Number);
                    startDate = new Date(y, m - 1, d);
                } else {
                    const [y, m, d] = finForm.date.split('-').map(Number);
                    startDate = new Date(y, m - 1, d);
                }

                for (let i = 0; i < numInstallments; i++) {
                    const entryDate = new Date(startDate);
                    
                    // Incrementa meses
                    if (['Cartão Crédito', 'Carnê/Boleto'].includes(finForm.method)) {
                        entryDate.setMonth(startDate.getMonth() + i);
                    } else if (i > 0) {
                        entryDate.setMonth(startDate.getMonth() + i);
                    }
                    
                    const y = entryDate.getFullYear();
                    const m = String(entryDate.getMonth() + 1).padStart(2, '0');
                    const d = String(entryDate.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;

                    let initialStatus = 'pending';
                    const today = new Date(); today.setHours(0,0,0,0);
                    const checkDate = new Date(entryDate); checkDate.setHours(0,0,0,0);
                    
                    if (['Dinheiro', 'Cartão Débito', 'Pix'].includes(finForm.method) && checkDate <= today) {
                        initialStatus = 'paid';
                    }

                    newEntries.push({
                        id: Date.now() + i,
                        date: dateStr,
                        desc: numInstallments > 1 ? `${finForm.desc} (${i + 1}/${numInstallments})` : finForm.desc,
                        value: installmentValue,
                        type: finForm.type,
                        category: finForm.category,
                        method: finForm.method,
                        cardId: finForm.method === 'Cartão Crédito' ? finForm.cardId : null,
                        status: initialStatus
                    });
                }
                
                setFinancialEntries([...newEntries, ...financialEntries]);
                setFinForm({ ...finForm, desc: '', value: '', installments: 1 });
                alert("Lançamento(s) adicionado(s) ao Fluxo!");
            };

            const handleEditEntry = (entry) => {
                setEditingId(entry.id);
                setFinForm({
                    date: entry.date, desc: entry.desc, value: entry.value, type: entry.type,
                    category: entry.category, method: entry.method, installments: 1, cardId: entry.cardId || ''
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const cancelEdit = () => { setEditingId(null); setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); };
            
            const handleAddAsset = () => { if (!assetForm.name || !assetForm.value) return alert("Preencha campos."); setUserAssets([...userAssets, { id: Date.now(), ...assetForm, value: parseFloat(assetForm.value) }]); setAssetForm({ name: '', value: '' }); };
            
            // --- NOVO HANDLE ADD LOAN (INTEGRADO AO FLUXO) ---
            const handleAddLoan = () => {
                if (!loanForm.name || !loanForm.value || !loanForm.date) return alert("Preencha todos os campos (Nome, Valor, Data).");
                
                const newLoanId = Date.now().toString();
                const loanValue = parseFloat(loanForm.value);
                
                // 1. Cria o registro na aba 'Receber' (Controle Geral)
                const newLoan = { 
                    id: newLoanId, 
                    ...loanForm, 
                    value: loanValue 
                };

                // 2. Cria automaticamente a entrada no Fluxo de Caixa (Pendente)
                const newEntry = {
                    id: Date.now() + 1, // ID diferente do loan
                    date: loanForm.date,
                    desc: `Recebimento: ${loanForm.name} - ${loanForm.desc}`,
                    value: loanValue,
                    type: 'income',      // Tipo Receita
                    category: 'Empréstimos', // Categoria Automática
                    method: 'Dinheiro',  // Método padrão (pode ser editado depois)
                    status: 'pending',   // Entra como pendente (a receber)
                    loanId: newLoanId    // Link para permitir exclusão conjunta
                };

                setUserLoans([...userLoans, newLoan]);
                setFinancialEntries([newEntry, ...financialEntries]);
                
                setLoanForm({ name: '', desc: '', value: '', date: '' });
                alert("Registrado em 'Receber' e adicionado ao Fluxo como Pendente!");
            };

            const handleAddCard = () => { if (!cardForm.name || !cardForm.limit || !cardForm.dueDay) return alert("Preencha campos."); setUserCards([...userCards, { id: Date.now().toString(), ...cardForm, limit: parseFloat(cardForm.limit), dueDay: cardForm.dueDay }]); setCardForm({ name: '', limit: '', dueDay: '' }); };
            const handleAddInvestment = () => { if (!investmentForm.name || !investmentForm.value) return alert("Preencha campos."); setUserInvestments([...userInvestments, { id: Date.now(), ...investmentForm, value: parseFloat(investmentForm.value) }]); setInvestmentForm({ type: 'Poupança', name: '', value: '' }); };

            const handleAddDebt = () => {
                if (!debtForm.name || !debtForm.totalValue || !debtForm.installments || !debtForm.dueDay) return alert("Preencha todos os campos.");
                
                const newDebtId = Date.now().toString();
                const installments = parseInt(debtForm.installments);
                const totalValue = parseFloat(debtForm.totalValue);
                const installmentValue = totalValue / installments;
                const dueDay = parseInt(debtForm.dueDay);
                
                const today = new Date();
                let startMonth = today.getMonth();
                let startYear = today.getFullYear();
                
                if (today.getDate() >= dueDay) {
                    startMonth++;
                    if(startMonth > 11) { startMonth = 0; startYear++; }
                }
                
                const debtStartDate = new Date(startYear, startMonth, dueDay);
                const newEntries = [];

                for (let i = 0; i < installments; i++) {
                    const entryDate = new Date(debtStartDate);
                    entryDate.setMonth(debtStartDate.getMonth() + i);
                    
                    const y = entryDate.getFullYear();
                    const m = String(entryDate.getMonth() + 1).padStart(2, '0');
                    const d = String(entryDate.getDate()).padStart(2, '0');
                    
                    newEntries.push({
                        id: Date.now() + i,
                        date: `${y}-${m}-${d}`,
                        desc: `${debtForm.name} (${i + 1}/${installments})`,
                        value: installmentValue,
                        type: 'expense',
                        category: 'Dívida/Financ.',
                        method: 'Carnê/Boleto',
                        status: 'pending',
                        debtId: newDebtId 
                    });
                }

                setUserDebts([...userDebts, { 
                    id: newDebtId, 
                    ...debtForm, 
                    totalValue: totalValue,
                    installments: installments
                }]);

                setFinancialEntries([...newEntries, ...financialEntries]);
                
                setDebtForm({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' });
                alert("Dívida cadastrada e parcelas geradas no Fluxo de Caixa!");
            };

            const deleteItem = (id, list, setList) => { if(confirm("Excluir item?")) setList(list.filter(i => i.id !== id)); };
            
            // --- NOVA FUNÇÃO DE LIXEIRA INTELIGENTE ---
            const handleTrashClick = (entry) => {
                if (entry.status === 'paid') {
                    if (confirm("Ocultar item do histórico? O valor continuará contabilizado no Saldo. (Para apagar definitivamente, vá em Configurações > Segurança)")) {
                        // Soft delete: apenas marca como oculto, mas mantem no array
                        setFinancialEntries(financialEntries.map(e => e.id === entry.id ? { ...e, hidden: true } : e));
                    }
                } else {
                    // Se for pendente, apaga de verdade pois não afeta saldo realizado
                    if (confirm("Excluir lançamento pendente permanentemente?")) {
                        setFinancialEntries(financialEntries.filter(e => e.id !== entry.id));
                    }
                }
            };
            
            // --- NOVA FUNÇÃO DE EXCLUSÃO INDIVIDUAL DO HISTÓRICO OCULTO ---
            const deleteHiddenItem = (id) => {
                if(confirm("Tem certeza? Isso apagará este item definitivamente e ALTERARÁ o seu Saldo.")) {
                    setFinancialEntries(financialEntries.filter(e => e.id !== id));
                }
            };

            const clearHiddenItems = () => {
                const count = financialEntries.filter(e => e.hidden).length;
                if (count === 0) return alert("Não há itens ocultos.");
                if(confirm(`Tem certeza? Isso apagará definitivamente ${count} itens ocultos e ALTERARÁ o seu Saldo atual. Essa ação não pode ser desfeita.`)) {
                    setFinancialEntries(financialEntries.filter(e => !e.hidden));
                    alert("Itens apagados e saldo recalculado.");
                }
            };

            const deleteDebt = (id) => { if(confirm("Apagar dívida e todas as parcelas pendentes?")) { setUserDebts(userDebts.filter(d => d.id !== id)); setFinancialEntries(financialEntries.filter(e => !(e.debtId === id && e.status === 'pending'))); } };
            
            // --- NOVA FUNÇÃO PARA APAGAR RECEBÍVEIS (E REMOVER DO FLUXO) ---
            const deleteLoan = (id) => {
                if(confirm("Apagar registro em 'Receber' e remover a entrada pendente do Fluxo?")) {
                    setUserLoans(userLoans.filter(l => l.id !== id));
                    // Remove do fluxo apenas se ainda estiver 'pending'. Se já pagou, mantém o histórico.
                    setFinancialEntries(financialEntries.filter(e => !(e.loanId === id && e.status === 'pending')));
                }
            };

            const toggleEntryStatus = (id) => {
                setFinancialEntries(financialEntries.map(entry => {
                    if (entry.id === id) return { ...entry, status: entry.status === 'paid' ? 'pending' : 'paid' };
                    return entry;
                }));
            };

            const updateDebtProgress = (id, change) => {};

            const exportData = () => { const dataStr = JSON.stringify({ financialEntries, userAssets, userLoans, userCards, userInvestments, userDebts }, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `backup_financeiro_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const importData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const data = JSON.parse(evt.target.result); if (confirm("Restaurar backup?")) { if(data.financialEntries) setFinancialEntries(data.financialEntries); if(data.userAssets) setUserAssets(data.userAssets); if(data.userLoans) setUserLoans(data.userLoans); if(data.userCards) setUserCards(data.userCards); if(data.userInvestments) setUserInvestments(data.userInvestments); if(data.userDebts) setUserDebts(data.userDebts); alert("Sucesso!"); } } catch { alert("Erro."); } }; reader.readAsText(file); e.target.value = ''; };

            const getCardName = (cardId) => { const card = userCards.find(c => c.id === cardId); return card ? card.name : 'Cartão Excluído'; };
            const toggleCardDetails = (cardId) => { setExpandedCardId(expandedCardId === cardId ? null : cardId); };
            const toggleDebtDetails = (debtId) => { setExpandedDebtId(expandedDebtId === debtId ? null : debtId); };
            const isOverdue = (dateStr) => { if (!dateStr) return false; const [y, m, d] = dateStr.split('-').map(Number); const date = new Date(y, m-1, d); const today = new Date(); today.setHours(0,0,0,0); return date < today; };
            
            const getDebtProgress = (debtId) => {
                const debtEntries = financialEntries.filter(e => e.debtId === debtId);
                const paidCount = debtEntries.filter(e => e.status === 'paid').length;
                const totalEntries = debtEntries.length > 0 ? debtEntries.length : 1;
                return { paid: paidCount, total: totalEntries };
            };

            const filteredEntries = useMemo(() => {
                return financialEntries.filter(entry => {
                    if (entry.hidden) return false; // Esconde os itens "soft deleted"
                    if (historyFilter === 'all') return true;
                    if (historyFilter === 'paid') return entry.status === 'paid';
                    if (historyFilter === 'pending') return entry.status === 'pending';
                    return true;
                });
            }, [financialEntries, historyFilter]);

            if (isLocked) {
                return ( <div className="min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white p-4 animate-fadeIn"> <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center"> <div className="mb-6 text-yellow-400"><IconWrapper name="lock" size={64} /></div> <h2 className="text-2xl font-bold mb-2">Agenda Bloqueada</h2> <p className="text-gray-400 mb-6 text-sm">Proteção Ativa.</p> <input type="password" value={pinInput} onChange={(e) => setPinInput(e.target.value)} className="w-full p-4 text-center text-2xl bg-gray-700 rounded-lg border border-gray-600 text-white mb-4 tracking-widest outline-none focus:border-yellow-500 transition-colors" placeholder="****" maxLength="6" inputMode="numeric" /> <button onClick={handleUnlock} className="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-yellow-400 transition-transform active:scale-95">Desbloquear</button> </div> </div> );
            }

            return (
                <div className="min-h-screen flex flex-col bg-gray-100 pb-20">
                    <header className="bg-red-800 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2"><IconWrapper name="dollar-sign" className="text-yellow-400" size={24}/> Agenda Financeira</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setView('settings')} className="p-2 bg-red-700 rounded hover:bg-red-600"><IconWrapper name="lock" size={20} /></button>
                                <button onClick={exportData} className="p-2 bg-red-700 rounded hover:bg-red-600"><IconWrapper name="download"/></button>
                                <label className="p-2 bg-red-700 rounded hover:bg-red-600 cursor-pointer"><input type="file" onChange={importData} className="hidden" accept=".json" /><IconWrapper name="refresh-cw"/></label>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white shadow px-4 pt-4 pb-2 sticky top-16 z-40">
                        <div className="flex space-x-1 overflow-x-auto hide-scrollbar">
                            <button onClick={() => setView('transactions')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'transactions' ? 'bg-red-100 text-red-800' : 'text-gray-500 hover:bg-gray-50'}`}>Fluxo</button>
                            <button onClick={() => setView('cards')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'cards' ? 'bg-purple-100 text-purple-800' : 'text-gray-500 hover:bg-gray-50'}`}>Cartões</button>
                            <button onClick={() => setView('investments')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'investments' ? 'bg-teal-100 text-teal-800' : 'text-gray-500 hover:bg-gray-50'}`}>Invest.</button>
                            <button onClick={() => setView('debts')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'debts' ? 'bg-indigo-100 text-indigo-800' : 'text-gray-500 hover:bg-gray-50'}`}>Dívidas</button>
                            <button onClick={() => setView('assets')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'assets' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:bg-gray-50'}`}>Bens</button>
                            <button onClick={() => setView('loans')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'loans' ? 'bg-orange-100 text-orange-800' : 'text-gray-500 hover:bg-gray-50'}`}>Receber</button>
                        </div>
                    </div>

                    <main className="container mx-auto p-4 flex-grow animate-fadeIn">
                        
                        {view === 'settings' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow border border-gray-100 text-center">
                                    <div className="mb-4 text-gray-600"><IconWrapper name="lock" size={48} className="mx-auto text-gray-400"/></div>
                                    <h3 className="font-bold text-xl text-gray-800 mb-2">Segurança</h3>
                                    {appPassword ? (
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-green-700 font-bold mb-4">✓ Proteção Ativa</p>
                                            <button onClick={handleRemovePassword} className="w-full bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600">Remover Senha</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <input type="password" placeholder="Nova Senha (mín. 4)" className="w-full p-3 border rounded-lg text-center text-lg tracking-widest bg-gray-50" value={newPasswordInput} onChange={(e) => setNewPasswordInput(e.target.value)} inputMode="numeric"/>
                                            <button onClick={handleSetPassword} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Ativar Proteção</button>
                                        </div>
                                    )}

                                    {/* ÁREA DE LIMPEZA DE HISTÓRICO OCULTO */}
                                    {financialEntries.filter(e => e.hidden).length > 0 && (
                                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 mt-6 text-left">
                                            <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2"><IconWrapper name="trash-2" size={16}/> Histórico Oculto</h4>
                                            <p className="text-sm text-orange-700 mb-3">
                                                Existem <strong>{financialEntries.filter(e => e.hidden).length}</strong> itens pagos que foram ocultados da lista principal, mas <strong>ainda estão somando no seu Saldo</strong>.
                                            </p>
                                            
                                            {/* LISTA DETALHADA PARA EXCLUSÃO INDIVIDUAL */}
                                            <ul className="mt-3 space-y-2 max-h-60 overflow-y-auto mb-4">
                                                {financialEntries.filter(e => e.hidden).map(entry => (
                                                    <li key={entry.id} className="flex justify-between items-center bg-white p-2 rounded border border-orange-100 shadow-sm">
                                                         <div>
                                                             <div className="font-bold text-gray-700 text-xs">{entry.desc}</div>
                                                             <div className="text-[10px] text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} • R$ {entry.value.toFixed(2)}</div>
                                                         </div>
                                                         <button onClick={() => deleteHiddenItem(entry.id)} className="text-red-500 hover:text-red-700 text-xs font-bold px-2 py-1 border border-red-200 rounded bg-red-50">
                                                             Apagar
                                                         </button>
                                                    </li>
                                                ))}
                                            </ul>

                                            <button onClick={clearHiddenItems} className="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700 text-sm">
                                                Limpar Todos Definitivamente (Alterará o Saldo)
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'transactions' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-green-100 p-3 rounded-xl border border-green-200">
                                        <div className="text-[10px] font-bold text-green-700 uppercase tracking-wide">Entradas</div>
                                        <div className="text-sm font-bold text-green-800">R$ {summary.income.toFixed(2)}</div>
                                    </div>
                                    <div className="bg-red-100 p-3 rounded-xl border border-red-200">
                                        <div className="text-[10px] font-bold text-red-700 uppercase tracking-wide">Saídas</div>
                                        <div className="text-sm font-bold text-red-800">R$ {summary.expense.toFixed(2)}</div>
                                    </div>
                                    <div className={`p-3 rounded-xl border-l-4 shadow-sm bg-white ${summary.balance >= 0 ? 'border-green-500' : 'border-red-500'}`}>
                                        <div className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Saldo</div>
                                        <div className={`text-sm font-bold ${summary.balance >= 0 ? 'text-gray-800' : 'text-red-600'}`}>R$ {summary.balance.toFixed(2)}</div>
                                    </div>
                                </div>
                                {summary.pendingExpense > 0 && <div className="bg-yellow-50 p-2 rounded border border-yellow-200 text-center text-xs text-yellow-700 font-bold">A Pagar (Pendente): R$ {summary.pendingExpense.toFixed(2)}</div>}

                                <div className="bg-white p-4 rounded-xl shadow border border-gray-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex justify-between items-center">
                                        {editingId ? 'Editar' : 'Nova Movimentação'}
                                        {editingId && <button onClick={cancelEdit} className="text-xs text-red-500 underline">Cancelar</button>}
                                    </h3>
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="date" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.date} onChange={e => setFinForm({...finForm, date: e.target.value})} />
                                            <input type="number" placeholder="Valor (R$)" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.value} onChange={e => setFinForm({...finForm, value: e.target.value})} />
                                        </div>
                                        <input type="text" placeholder="Descrição" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.desc} onChange={e => setFinForm({...finForm, desc: e.target.value})} />
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.category} onChange={e => setFinForm({...finForm, category: e.target.value})}>
                                                <option>Outros</option><option>Dízimo</option><option>Oferta</option><option>Alimentação</option><option>Contas</option><option>Transporte</option><option>Saúde</option><option>Lazer</option><option>Salário</option>
                                            </select>
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.method} onChange={e => setFinForm({...finForm, method: e.target.value})}>
                                                <option>Dinheiro</option><option>Cartão Crédito</option><option>Cartão Débito</option><option>Pix</option>
                                                <option>Carnê/Boleto</option>
                                            </select>
                                        </div>

                                        {/* CARTÃO */}
                                        {finForm.method === 'Cartão Crédito' && (
                                            <div className="bg-yellow-50 p-3 rounded space-y-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-yellow-800">Cartão:</span>
                                                    <select className="w-full p-1 border rounded text-sm" value={finForm.cardId} onChange={e => setFinForm({...finForm, cardId: e.target.value})}>
                                                        <option value="">Selecione...</option>
                                                        {userCards.map(card => <option key={card.id} value={card.id}>{card.name}</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-yellow-800">Parcelas:</span>
                                                    <input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} />
                                                </div>
                                            </div>
                                        )}
                                        {/* CARNÊ/BOLETO */}
                                        {finForm.method === 'Carnê/Boleto' && !editingId && (
                                            <div className="bg-blue-50 p-3 rounded space-y-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-blue-800">Parcelas:</span>
                                                    <input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} />
                                                </div>
                                            </div>
                                        )}

                                        <div className="flex gap-2 pt-2">
                                            <button onClick={() => setFinForm({...finForm, type: 'income'})} className={`flex-1 py-2 rounded text-sm font-bold transition ${finForm.type === 'income' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-400'}`}>Receita</button>
                                            <button onClick={() => setFinForm({...finForm, type: 'expense'})} className={`flex-1 py-2 rounded text-sm font-bold transition ${finForm.type === 'expense' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-400'}`}>Despesa</button>
                                        </div>
                                        <button onClick={handleAddEntry} className="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-gray-700 mt-2 flex justify-center items-center gap-2"><IconWrapper name={editingId ? 'edit-2' : 'plus'}/> {editingId ? 'Atualizar' : 'Adicionar'}</button>
                                    </div>
                                </div>

                                {/* LISTA */}
                                <div className="bg-white rounded-xl shadow overflow-hidden">
                                    <div className="flex justify-between items-center bg-gray-50 px-4 py-2">
                                        <span className="font-bold text-xs text-gray-500 uppercase">Histórico</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setHistoryFilter('all')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'all' ? 'bg-gray-200' : 'text-gray-400'}`}>Todos</button>
                                            <button onClick={() => setHistoryFilter('pending')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'text-gray-400'}`}>Pendentes</button>
                                            <button onClick={() => setHistoryFilter('paid')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'paid' ? 'bg-green-100 text-green-700' : 'text-gray-400'}`}>Pagos</button>
                                        </div>
                                    </div>
                                    <ul className="divide-y divide-gray-100">
                                        {filteredEntries.length === 0 ? <li className="p-4 text-center text-gray-400 text-sm">Sem registos visíveis.</li> : 
                                        filteredEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).map(entry => (
                                            <li key={entry.id} className={`p-4 flex justify-between items-center ${entry.status === 'paid' ? 'bg-white opacity-75' : 'bg-white'}`}>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`font-bold ${entry.status === 'paid' ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{entry.desc}</span>
                                                        <span className="text-[10px] px-2 py-0.5 bg-gray-100 rounded text-gray-500">{entry.category}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-1">
                                                        {new Date(entry.date).toLocaleDateString('pt-BR')} • {entry.method}
                                                        {entry.method === 'Cartão Crédito' && entry.cardId && (
                                                            <span className="bg-purple-100 text-purple-700 px-1 rounded border border-purple-200 text-[10px]">
                                                                {getCardName(entry.cardId)}
                                                            </span>
                                                        )}
                                                        {isOverdue(entry.date) && entry.status !== 'paid' && entry.type === 'expense' && <span className="text-red-500 font-bold ml-1 bg-red-100 px-1 rounded">Vencido</span>}
                                                    </div>
                                                </div>
                                                <div className="text-right flex flex-col items-end gap-2">
                                                    <div className={`font-bold ${entry.type === 'income' ? 'text-green-600' : 'text-red-600'} ${entry.status === 'pending' ? '' : 'opacity-50'}`}>
                                                        {entry.type === 'income' ? '+' : '-'} {parseFloat(entry.value).toFixed(2)}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditEntry(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-400 hover:bg-blue-50 hover:text-blue-500 transition-all"><IconWrapper name="edit-2" size={14}/></button>
                                                        <button onClick={() => toggleEntryStatus(entry.id)} className={`w-8 h-8 flex items-center justify-center rounded-full border transition-all ${entry.status === 'paid' ? 'bg-green-500 border-green-600 text-white' : 'bg-white border-gray-300 text-gray-300'}`}><IconWrapper name="check" size={16} /></button>
                                                        {/* LIXEIRA INTELIGENTE AQUI */}
                                                        <button onClick={() => handleTrashClick(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-300 hover:bg-red-50 hover:text-red-500 transition-all"><IconWrapper name="trash-2" size={14}/></button>
                                                    </div>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <SimplePieChart data={chartData} onSliceClick={handlePieClick} />
                            </div>
                        )}

                        {view === 'cards' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded-xl shadow">
                                    <h3 className="font-bold text-purple-700 mb-3 text-sm flex items-center gap-2"><IconWrapper name="credit-card"/> Novo Cartão</h3>
                                    <div className="flex gap-2 mb-2">
                                        <input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={cardForm.name} onChange={e => setCardForm({...cardForm, name: e.target.value})} />
                                        <input type="number" placeholder="Limite" className="w-24 p-2 border rounded text-sm" value={cardForm.limit} onChange={e => setCardForm({...cardForm, limit: e.target.value})} />
                                        <input type="number" placeholder="Dia Venc." min="1" max="31" className="w-20 p-2 border rounded text-sm" value={cardForm.dueDay} onChange={e => setCardForm({...cardForm, dueDay: e.target.value})} />
                                    </div>
                                    <button onClick={handleAddCard} className="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700">Adicionar Cartão</button>
                                </div>
                                
                                <div className="space-y-4">
                                    {userCards.map(card => {
                                        const totalUsed = getTotalCardUsage(card.id); 
                                        const currentInvoice = getCurrentInvoiceValue(card.id); 
                                        const available = card.limit - totalUsed; 
                                        const percentUsed = Math.min(100, (totalUsed / card.limit) * 100);
                                        
                                        // Filtra os lançamentos deste cartão que ainda não foram pagos (parcelas futuras/atuais)
                                        const cardEntries = financialEntries
                                            .filter(e => e.cardId === card.id && e.status === 'pending')
                                            .sort((a,b) => new Date(a.date) - new Date(b.date));

                                        return (
                                            <div key={card.id} className="bg-white rounded-xl shadow-lg overflow-hidden transition-all">
                                                {/* Área clicável para expandir */}
                                                <div 
                                                    onClick={() => toggleCardDetails(card.id)}
                                                    className="bg-gradient-to-r from-gray-800 to-gray-700 p-5 text-white relative cursor-pointer hover:opacity-95"
                                                >
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div><h4 className="font-bold text-lg">{card.name}</h4><span className="text-xs text-gray-400">Vence dia {card.dueDay}</span></div>
                                                        <IconWrapper name="credit-card" className="text-gray-500 opacity-50" size={32}/>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 text-sm mb-4">
                                                        <div><div className="text-xs text-gray-400">Fatura Atual (Mês)</div><div className="font-bold text-red-300">R$ {currentInvoice.toFixed(2)}</div></div>
                                                        <div className="text-right"><div className="text-xs text-gray-400">Disponível</div><div className="font-bold text-green-300">R$ {available.toFixed(2)}</div></div>
                                                    </div>
                                                    <div className="w-full bg-gray-600 h-2 rounded-full overflow-hidden mb-2">
                                                        <div className={`h-full ${percentUsed > 90 ? 'bg-red-500' : 'bg-green-500'}`} style={{width: `${percentUsed}%`}}></div>
                                                    </div>
                                                    
                                                    {/* Botão de Excluir Cartão */}
                                                    <button onClick={(e) => { e.stopPropagation(); deleteItem(card.id, userCards, setUserCards); }} className="absolute top-2 right-2 text-gray-500 hover:text-red-400"><IconWrapper name="trash-2" size={16}/></button>
                                                    
                                                    {/* Indicador visual de expandir */}
                                                    <div className="text-center text-[10px] text-gray-400 mt-1">
                                                        {expandedCardId === card.id ? '▲ Ocultar Detalhes' : '▼ Ver Parcelas e Fatura'}
                                                    </div>
                                                </div>

                                                {/* Lista de Parcelas (Só aparece se clicar) */}
                                                {expandedCardId === card.id && (
                                                    <div className="bg-gray-50 p-4 border-t border-gray-200 animate-fadeIn">
                                                        <h5 className="font-bold text-gray-500 text-xs uppercase mb-3">Parcelas a Vencer (Fatura Aberta e Futuras)</h5>
                                                        {cardEntries.length === 0 ? (
                                                            <p className="text-center text-sm text-gray-400">Nenhuma compra pendente neste cartão.</p>
                                                        ) : (
                                                            <ul className="space-y-2">
                                                                {cardEntries.map(entry => (
                                                                    <li key={entry.id} className="flex justify-between items-center bg-white p-3 rounded border border-gray-100 shadow-sm">
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 text-sm">{entry.desc}</div>
                                                                            <div className="text-xs text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} • {entry.category}</div>
                                                                        </div>
                                                                        <div className="font-bold text-red-600 text-sm">
                                                                            R$ {entry.value.toFixed(2)}
                                                                        </div>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        )}
                                                        <div className="mt-4 pt-2 border-t border-gray-200 text-right">
                                                            <span className="text-xs font-bold text-gray-500 uppercase mr-2">Total Pendente:</span>
                                                            <span className="font-bold text-gray-800">R$ {cardEntries.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {view === 'debts' && (
                            <div className="space-y-6">
                                <div className="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total Dívidas Longas</div><div className="text-3xl font-bold">R$ {userDebts.reduce((acc, curr) => acc + (curr.totalValue - (curr.totalValue/curr.installments * (getDebtProgress(curr.id).paid))), 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow border border-indigo-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2"><IconWrapper name="briefcase"/> Nova Dívida/Financiamento</h3>
                                    <div className="grid grid-cols-1 gap-3">
                                        <input type="text" placeholder="Nome (Ex: Casa)" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.name} onChange={e => setDebtForm({...debtForm, name: e.target.value})} />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="Valor Total" className="flex-1 p-2 border rounded text-sm" value={debtForm.totalValue} onChange={e => setDebtForm({...debtForm, totalValue: e.target.value})} />
                                            <input type="number" placeholder="Parcelas" className="w-24 p-2 border rounded text-sm" value={debtForm.installments} onChange={e => setDebtForm({...debtForm, installments: e.target.value})} />
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <label className="block text-[10px] font-bold text-gray-400 mb-1">Dia Vencimento</label>
                                                <input type="number" min="1" max="31" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.dueDay} onChange={e => setDebtForm({...debtForm, dueDay: e.target.value})} placeholder="Dia" />
                                            </div>
                                            <div className="flex-1 flex items-end"><button onClick={handleAddDebt} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Salvar</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {userDebts.map(debt => {
                                        const { paid, total } = getDebtProgress(debt.id);
                                        const remaining = debt.totalValue - ((debt.totalValue/debt.installments) * paid);
                                        const progress = (paid / debt.installments) * 100;
                                        return (
                                            <div key={debt.id} className="bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-indigo-500">
                                                <div className="p-4">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h4 className="font-bold text-indigo-900 text-lg">{debt.name}</h4>
                                                        <button onClick={() => deleteDebt(debt.id)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-500 mb-2">
                                                        <span>Pago: {paid}/{debt.installments}</span>
                                                        <span>Restante: R$ {remaining.toFixed(2)}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 h-3 rounded-full overflow-hidden mb-3">
                                                        <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${progress}%`}}></div>
                                                    </div>
                                                    <p className="text-[10px] text-center text-gray-400">Gerencie as parcelas na aba FLUXO.</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'investments' && (
                            <div className="space-y-6">
                                <div className="bg-teal-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total Investido</div><div className="text-3xl font-bold">R$ {userInvestments.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Investimento</h3><div className="flex flex-col gap-3"><div className="flex gap-2"><select className="w-1/3 p-2 border rounded text-sm bg-gray-50" value={investmentForm.type} onChange={e => setInvestmentForm({...investmentForm, type: e.target.value})}><option>Poupança</option><option>CDB</option><option>Ações</option><option>Fundos</option><option>Outros</option></select><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={investmentForm.name} onChange={e => setInvestmentForm({...investmentForm, name: e.target.value})} /></div><div className="flex gap-2"><input type="number" placeholder="Valor (R$)" className="flex-1 p-2 border rounded text-sm" value={investmentForm.value} onChange={e => setInvestmentForm({...investmentForm, value: e.target.value})} /><button onClick={handleAddInvestment} className="w-24 bg-teal-600 text-white py-2 rounded font-bold hover:bg-teal-700">Salvar</button></div></div></div>
                                <div className="space-y-3">{userInvestments.map(inv => (<div key={inv.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 flex justify-between items-center"><div><span className="text-[10px] font-bold text-teal-600 bg-teal-50 px-2 py-0.5 rounded uppercase">{inv.type}</span><div className="font-bold text-gray-800 mt-1">{inv.name}</div></div><div className="flex items-center gap-3"><span className="font-bold text-teal-700">R$ {inv.value.toFixed(2)}</span><button onClick={() => deleteItem(inv.id, userInvestments, setUserInvestments)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'assets' && (
                            <div className="space-y-6">
                                <div className="bg-blue-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Património Total</div><div className="text-3xl font-bold">R$ {userAssets.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Bem</h3><div className="flex gap-2 mb-2"><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={assetForm.name} onChange={e => setAssetForm({...assetForm, name: e.target.value})} /><input type="number" placeholder="Valor" className="w-24 p-2 border rounded text-sm" value={assetForm.value} onChange={e => setAssetForm({...assetForm, value: e.target.value})} /></div><button onClick={handleAddAsset} className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Salvar Bem</button></div>
                                <div className="grid grid-cols-1 gap-3">{userAssets.map(asset => (<div key={asset.id} className="bg-white p-4 rounded-xl shadow flex justify-between items-center border-l-4 border-blue-500"><span className="font-bold text-gray-800">{asset.name}</span><div className="flex items-center gap-3"><span className="font-bold text-blue-600">R$ {asset.value.toFixed(2)}</span><button onClick={() => deleteItem(asset.id, userAssets, setUserAssets)} className="text-gray-400 hover:text-red-500"><IconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'loans' && (
                            <div className="space-y-6">
                                <div className="bg-orange-500 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total a Receber</div><div className="text-3xl font-bold">R$ {userLoans.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Registar Dívida</h3><input type="text" placeholder="Quem deve?" className="w-full p-2 border rounded text-sm mb-2" value={loanForm.name} onChange={e => setLoanForm({...loanForm, name: e.target.value})} /><div className="flex gap-2 mb-2"><input type="number" placeholder="Valor" className="flex-1 p-2 border rounded text-sm" value={loanForm.value} onChange={e => setLoanForm({...loanForm, value: e.target.value})} /><input type="date" className="w-32 p-2 border rounded text-sm" value={loanForm.date} onChange={e => setLoanForm({...loanForm, date: e.target.value})} /></div><input type="text" placeholder="Motivo" className="w-full p-2 border rounded text-sm mb-3" value={loanForm.desc} onChange={e => setLoanForm({...loanForm, desc: e.target.value})} /><button onClick={handleAddLoan} className="w-full bg-orange-500 text-white py-2 rounded font-bold hover:bg-orange-600">Adicionar</button></div>
                                <div className="space-y-3">{userLoans.map(loan => (<div key={loan.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-orange-400"><div className="flex justify-between items-start mb-1"><h4 className="font-bold text-gray-800">{loan.name}</h4><span className="font-bold text-orange-600">R$ {loan.value.toFixed(2)}</span></div><p className="text-sm text-gray-600">{loan.desc}</p><div className="flex justify-between items-center mt-2 pt-2 border-t border-gray-100"><span className="text-xs text-gray-400">Previsto: {loan.date ? new Date(loan.date).toLocaleDateString('pt-BR') : 'Sem data'}</span><button onClick={() => deleteLoan(loan.id)} className="text-red-400 hover:text-red-600 text-xs font-bold flex items-center gap-1"><IconWrapper name="trash-2" size={12}/> Apagar</button></div></div>))}</div>
                            </div>
                        )}
                    </main>

                    <footer className="bg-gray-900 text-gray-400 text-center p-8 text-xs mt-auto">
                        <p>&copy; Sistema Vida Financeiro</p>
                        <p className="mt-1">Jânio Carlos P J - Atualização: 30/11/2025</p>
                        <a href="https://wa.me/5575998312170" target="_blank" className="inline-block mt-3 text-green-400 font-bold hover:text-green-300">WhatsApp Suporte +55 75998312170</a>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><FinancialApp /></ErrorBoundary>);
    </script>
</body>
</html>